<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kubernetes í†µí•© ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #111827;
      color: #E5E7EB;
    }
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
      animation: fade-in 0.2s ease-out;
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1f2937; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
  </style>
</head>
<body>
<div id="app" class="container mx-auto px-4 py-8 min-h-screen">
  <!-- í—¤ë” -->
  <header class="mb-8 p-4 bg-gray-800/30 rounded-xl shadow-lg border border-gray-700">
    <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 mb-2">
      Kubernetes í†µí•© ëŒ€ì‹œë³´ë“œ
    </h1>
    <p class="text-center text-gray-400 text-lg">Rust & Vue.js ê¸°ë°˜ ì‹¤ì‹œê°„ í´ëŸ¬ìŠ¤í„° ëª¨ë‹ˆí„°ë§</p>
  </header>

  <!-- ì—°ê²° ìƒíƒœ ë° ì˜¤ë¥˜ -->
  <div v-if="connecting" class="text-center py-20">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto mb-4"></div>
    <p class="text-2xl text-gray-400">{{ reconnecting ? 'ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²° ì¤‘...' : 'ì„œë²„ì— ì—°ê²°í•˜ëŠ” ì¤‘...' }}</p>
  </div>

  <div v-else-if="error" class="bg-red-900/50 border border-red-700 text-red-300 px-6 py-4 rounded-lg mb-8 shadow-md">
    <p><span class="font-bold">ì˜¤ë¥˜:</span> {{ error }}</p>
  </div>

  <!-- í´ëŸ¬ìŠ¤í„° ë¦¬ìŠ¤íŠ¸ ë° ìƒì„¸ -->
  <main v-if="allClusters.length && !connecting && !error" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- ì¢Œì¸¡ í´ëŸ¬ìŠ¤í„° ëª©ë¡ -->
    <aside class="lg:col-span-1 bg-gray-800/50 p-6 rounded-xl border border-gray-700 self-start lg:sticky lg:top-8 shadow-lg h-full max-h-[calc(100vh-120px)] flex flex-col">
      <h2 class="text-2xl font-semibold text-white mb-4">í´ëŸ¬ìŠ¤í„° ëª©ë¡ ({{ allClusters.length }})</h2>
      <div class="flex-grow overflow-y-auto pr-2 -mr-2">
        <ul class="space-y-3">
          <li v-for="cluster in allClusters" :key="cluster.name"
              @click="selectItem(cluster)"
              :class="{'bg-blue-600/30 border-blue-500': selectedItem?.name === cluster.name}"
              class="p-4 rounded-lg border border-gray-700 cursor-pointer transition-colors duration-200 animate-fade-in hover:bg-gray-700/50">
            <div class="flex justify-between items-center">
              <div>
                <p class="font-semibold text-white text-lg">{{ cluster.name }}</p>
                <p class="text-sm text-gray-400">{{ cluster.node_count }} ë…¸ë“œ, {{ cluster.pod_count }} íŒŒë“œ</p>
              </div>
              <span class="text-blue-400 text-2xl">ğŸŒ</span>
            </div>
          </li>
        </ul>
      </div>
    </aside>

    <!-- ìš°ì¸¡ ìƒì„¸ ë³´ê¸° -->
    <section class="lg:col-span-2 bg-gray-800/50 p-6 rounded-xl border border-gray-700 shadow-lg relative">
      <button v-if="selectedItem" @click="goBackToMain"
              class="absolute top-4 right-4 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 z-10">
        â† ë’¤ë¡œ ê°€ê¸°
      </button>
      <div v-if="!selectedItem" class="text-center py-20">
        <p class="text-2xl text-gray-400">ì™¼ìª½ì—ì„œ í´ëŸ¬ìŠ¤í„°ë¥¼ ì„ íƒí•˜ì—¬ ë…¸ë“œ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.</p>
      </div>
      <div v-else class="animate-fade-in">
        <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-600 mb-6">
          ğŸŒ í´ëŸ¬ìŠ¤í„°: {{ selectedItem.name }}
        </h2>
        <h3 class="text-2xl font-semibold text-white mb-4">ë…¸ë“œ ëª©ë¡ ({{ selectedItem.nodes.length }})</h3>
        <div class="space-y-4 max-h-[calc(100vh-220px)] overflow-y-auto pr-2 -mr-2">
          <div v-for="node in selectedItem.nodes" :key="node.name"
               class="p-4 rounded-lg border border-gray-700 transition-colors duration-200 animate-fade-in">
            <p class="font-semibold text-white text-lg">{{ node.name }}</p>
            <p class="text-sm text-gray-400">{{ node.pod_count }} íŒŒë“œ, {{ node.container_count }} ì»¨í…Œì´ë„ˆ</p>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
const { createApp, ref, onMounted, onUnmounted } = Vue;

createApp({
  setup() {
    const allClusters = ref([]);
    const connecting = ref(true);
    const reconnecting = ref(false);
    const error = ref(null);
    const selectedItem = ref(null);
    let socket = null;

    const connectWebSocket = () => {
      if (socket && socket.readyState <= 1) return;
      const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      socket = new WebSocket(`${wsProtocol}//${location.host}/ws/`);

      socket.onopen = () => {
        connecting.value = false;
        reconnecting.value = false;
        error.value = null;
        console.info("âœ… WebSocket ì—°ê²° ì„±ê³µ");
      };

      socket.onmessage = ({ data }) => {
        try {
          const newClusterData = JSON.parse(data);
          const idx = allClusters.value.findIndex(c => c.name === newClusterData.name);
          if (idx !== -1) Object.assign(allClusters.value[idx], newClusterData);
          else allClusters.value.push(newClusterData);

          if (selectedItem.value?.name === newClusterData.name) {
            Object.assign(selectedItem.value, newClusterData);
          }
        } catch (e) {
          console.error("ğŸ“› JSON íŒŒì‹± ì˜¤ë¥˜:", e);
        }
      };

      socket.onerror = () => {
        error.value = "âŒ ì„œë²„ì™€ì˜ ì‹¤ì‹œê°„ ì—°ê²° ì‹¤íŒ¨";
        connecting.value = false;
      };

      socket.onclose = () => {
        console.warn("ğŸš« WebSocket ì—°ê²° ì¢…ë£Œë¨. ì¬ì—°ê²° ì‹œë„...");
        connecting.value = true;
        reconnecting.value = true;
        setTimeout(connectWebSocket, 5000);
      };
    };

    const goBackToMain = () => selectedItem.value = null;
    const handleEscKey = (e) => { if (e.key === 'Escape') goBackToMain(); };

    onMounted(() => {
      connectWebSocket();
      window.addEventListener('keydown', handleEscKey);
    });

    onUnmounted(() => {
      window.removeEventListener('keydown', handleEscKey);
    });

    const selectItem = (item) => {
      selectedItem.value = item;
    };

    return {
      allClusters,
      connecting,
      reconnecting,
      error,
      selectedItem,
      goBackToMain,
      selectItem
    };
  }
}).mount('#app');
</script>
</body>
</html>